services:
  # ====================================================================
  # 1. LAYANAN APLIKASI (Laravel + PHP-FPM + Node.js/Vite)
  # ====================================================================
  laravel-inertia-app:
    build:
      context: .
      dockerfile: docker/Dockerfile-laravel
    image: laravel-inertia-app
    container_name: laravel-inertia-app
    volumes:
      - .:/var/www/html
      - vendor-cache:/var/www/html/vendor
      - node_modules-cache:/var/www/html/node_modules
    ports:
      - "5173:5173" # Untuk Vite HMR (Pengembangan)
    env_file:
      - .env
    environment:
      DB_HOST: mysql_db # <--- HOST adalah NAMA LAYANAN di Proyek A
      DB_PORT: 3306
      VITE_PORT: 5173
    networks:
      - app_internal_net  # <--- Jaringan Internal Nginx <-> Laravel
      - external_db_link  # <--- Jaringan Eksternal ke Proyek A
    restart: always

  # ====================================================================
  # 2. LAYANAN WEB SERVER (Nginx - Reverse Proxy)
  # ====================================================================
  nginx-proxy:
    image: nginx:stable-alpine
    container_name: nginx-proxy
    volumes:
      - .:/var/www/html
      - ./docker/nginx/default.conf:/etc/nginx/conf.d/default.conf:ro
    ports:
      - "8099:80"
    networks:
      - app_internal_net # <--- Hanya perlu jaringan internal
    depends_on:
      - laravel-inertia-app
    restart: always

# --- JARINGAN DAN VOLUME ---
networks:
  # JARINGAN INTERNAL: Hanya untuk komunikasi di dalam Proyek B
  app_internal_net:
    driver: bridge
    
  # JARINGAN EKSTERNAL: Link ke DB di Proyek A
  external_db_link:
    external: true
    # NAMA: Harus sesuai dengan nama Jaringan Asli yang dibuat di Proyek A
    # Rumus: [Nama Folder Proyek A]_[Nama Jaringan di Proyek A]
    name: db_master_shared # <--- GANTI 'psis-legacy' JIKA BEDA
    
volumes:
  vendor-cache:
  node_modules-cache:
